<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../static/third/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/third/adminlte/css/AdminLTE.min.css">
    <link rel="stylesheet" href="../static/third/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../static/third/easyui/themes/insdep/easyui.css">
    <link rel="stylesheet" href="../static/third/easyui/themes/insdep/easyui_animation.css">
    <link rel="stylesheet" href="../static/third/easyui/themes/insdep/easyui_plus.css">
    <link rel="stylesheet" href="../static/third/easyui/themes/insdep/icon.css">
    <link rel="stylesheet" href="../static/css/common.css">
    <title>指标修改</title>
    <script src="../static/third/jquery.js"></script>
    <script src="../static/third/bootstrap/js/bootstrap.min.js"></script>
    <script src="../static/third/easyui/jquery.easyui.min.js"></script>
    <script src="../static/third/easyui/themes/insdep/jquery.insdep-extend.min.js"></script>
    <script src="../static/third/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="../static/js/utils.js"></script>
    <script src="../static/js/customConfig.js"></script>
    <script src="../static/js/easyui-extention_ws.js"></script>
    <script src="../static/js/i18n/zh_CN.js"></script>
    <script src="../static/js/purchase/serializeJson.js"></script>
</head>
<body>
<table id="dataGrid"></table>
<div id="tb" style="padding:5px;height:auto">
    <form id="filterForm" action="#">
    	<table>
	    	<tr>
		    	<td>
					<a id='save' href="javascript:;" class="easyui-linkbutton" iconCls="icon-save"  onclick="save()">保存</a>&nbsp;&nbsp;&nbsp;&nbsp;
			        <a id='cancel' href="javascript:;" class="easyui-linkbutton" iconCls="icon-cancel" onclick="cancel()">取消</a>
		        </td>
	        </tr>
    		<tr>
	    		<td>
					额度时间:
					<input id="report_year_week" name="report_year_week" class="txt" value="$!currentweek" readonly="readonly"  style="background-color: #EEEEEE "/>
	    		</td>
    		</tr>
        </table>
    </form>
</div>
<script type="text/javascript">
function cancel(){
	 window.open("/gate/gateOfLimit",'_self');
}
$(function () {
	//生成grid
    var datagrid = $('#dataGrid').datagrid({
       url: "/gate/findGateOfLimitListWithoutSum",
       fit: true,
       fitColumns: true,
       toolbar: $('#tb'),
       singleSelect: true,
       nowrap: true,
       rownumbers: true,
		selectOnCheck: false,
		checkOnSelect: false,
		onClickRow: onClickRow,
        columns: [
            [
               {
                    field: 'id',
                    title: '序号',
                    width: 10,
                    align: 'center',
                    hidden:true
                },
                {
                	field:'category_id',
                	title:'品类',
                	width:100,
                	align:'center'
                },
                {
                    field: 'ed_channel_name',
                    title: '渠道',
                    width: 50,
                    align: 'center'
                },
                {
                    field: 'target_num',
                    title: '指标',
                    width: 50,
                    align: 'center',
                    editor:{
                        type: 'numberbox',
                        options: { required: true,decimalSeparator:".",min:0, precision:"2"}
                    }
                },
                {
                	field:'limit_num',
                	title:'额度',
                	width:80,
                	align:'center'
                },{
                	field:'total_num',
                	title:'总库存',
                	width:50,
                	align:'center'
                },
                {
                	field:'on_way_num',
                	title:'在途',
                	width:50,
                	align:'center'
                },
                {
                	field:'loan_num',
                	title:'拆借',
                	width:50,
                	align:'center'
                },
                {
                	field:'used_num',
                	title:'本周已用',
                	width:100,
                	align:'center'
                },
                {
                    field: 'available_num',
                    title: '可用额度',
                    width: 50,
                    align: 'center'
                }
            ]
        ]
    });
});
var editIndex = undefined;
function endEditing(){
	if($('#dataGrid').datagrid("getRows").length<=0) return true;
	if (editIndex == undefined){return true}
	if ($('#dataGrid').datagrid('validateRow', editIndex)){
		var rows = $('#dataGrid').datagrid('getChecked');
		var editcheck = false;
		$.each(rows, function(index, item) {        
			if(item==$('#dataGrid').datagrid('getRows')[editIndex])
				editcheck =true;
				return false;
		});
		$('#dataGrid').datagrid('endEdit', editIndex);
		if(editcheck) {
			$('#dataGrid').datagrid('checkRow',editIndex);
		}
		editIndex = undefined;
		return true;
	}
}
function onClickRow(index){
	if (editIndex != index){
		if (endEditing()){
			$('#dataGrid').datagrid('selectRow', index)
			.datagrid('beginEdit', index);
			editIndex = index;
		} else {
			$('#dataGrid').datagrid('selectRow', editIndex);
		}
	}
}
function save(){
	if (endEditing()){
		//var changeRows = $('#dataGrid').datagrid('getChanges');
		$('#dataGrid').datagrid('acceptChanges');
		var rows = $('#dataGrid').datagrid('getRows');
		console.info(rows);
		$.messager.progress({
			title: '请等待',
			text: '正在保存……'
		})
		jQuery.ajax({
        	url: "/gate/saveGateOfLimitTarget",   // 提交的页面
			type: "POST",                   // 设置请求类型为"POST"，默认为"GET"
			data:{"allData":JSON.stringify(rows),"report_year_week": $('#report_year_week').val()},
			success: function (data) {
				var result = data.message;
				if(result){$.messager.alert('提示',result,'info', function(){
					if(data.totalCount==1){
						//$('#dataGrid').datagrid('reload');
						window.open("/gate/gateOfLimit",'_self');
					}
				});}
			},
			complete: function(){
				$.messager.progress('close');
			}
 		});
	}
}
</script>
</body>